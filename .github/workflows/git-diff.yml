name: Git Diff Extraction

on:
    repository_dispatch:
        types: [git-diff]

jobs:
    extract-changes:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.client_payload.branch }}
                  fetch-depth: 20

            - name: Extract Git Diff (Benchmark Search)
              shell: bash
              run: |
                  # 1. Search for the specific benchmark commits
                  echo "Searching history for 'Commit 1' or 'Commit 2'..."

                  TARGET_COMMIT=""

                  for i in {0..19}; do
                    # Get the commit message subject for HEAD~i
                    MSG=$(git log -1 --format="%s" HEAD~$i)
                    
                    if [[ "$MSG" == "Commit 1" || "$MSG" == "Commit 2" ]]; then
                      echo "âœ… Found benchmark checkpoint at HEAD~$i: '$MSG'"
                      TARGET_COMMIT="HEAD~$i"
                      break
                    fi
                  done

                  # 2. Generate Diff or Fail
                  if [ -z "$TARGET_COMMIT" ]; then
                    echo "âš ï¸  Could not find 'Commit 1' or 'Commit 2' in the last 20 commits."
                    echo "No benchmark commit found" > dff.txt
                  else
                    echo "ðŸ“ Extracting diff for commit $TARGET_COMMIT..."
                    # We exclude artifact files just in case, but primarily rely on the specific commit selection
                    git diff ${TARGET_COMMIT}^ ${TARGET_COMMIT} -- . ':!dff.txt' ':!llm.txt' ':!tca.json' ':!prioritization_report.md' > dff.txt
                  fi

                  echo "Diff size: $(wc -c < dff.txt) bytes"

            - name: Commit Diff Artifact
              run: |
                  git config --global user.name 'JTopas Automation'
                  git config --global user.email 'automation@jtopas.local'

                  git add dff.txt

                  if git diff --staged --quiet; then
                    echo "No changes to dff.txt. Skipping commit."
                  else
                    git commit -m "chore: update dff.txt [skip ci]"
                    git pull origin ${{ github.event.client_payload.branch }} --rebase
                    git push origin ${{ github.event.client_payload.branch }}
                  fi
