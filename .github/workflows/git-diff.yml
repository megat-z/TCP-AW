name: Git Diff Extraction

on:
  repository_dispatch:
    types: [git-diff]

jobs:
  extract-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch }}
          fetch-depth: 2 

      - name: Extract Git Diff (Excluding Artifacts)
        run: |
          # We use pathspec exclusions (:!file) to ignore our own automation outputs.
          # This ensures the LLM only sees real source code changes.
          git diff HEAD^ HEAD -- . ':!dff.txt' ':!llm.txt' ':!tca.json' ':!prioritization_report.md' > dff.txt
          
          # Debug: Print file size to log
          echo "Diff size: $(wc -c < dff.txt) bytes"

      - name: Commit Diff Artifact
        run: |
          git config --global user.name 'JTopas Automation'
          git config --global user.email 'automation@jtopas.local'
          git add dff.txt
          git commit -m "chore: update dff.txt [skip ci]"
          
          # SAFETY: Rebase before push to handle race conditions
          git pull origin ${{ github.event.client_payload.branch }} --rebase
          git push origin ${{ github.event.client_payload.branch }}
